@page "/register"
@using frontend.Services
@using System.ComponentModel.DataAnnotations
@inject AuthService AuthService
@inject NavigationManager Navigation

<div class="min-h-screen flex items-center justify-center bg-gray-100">
    <div class="max-w-md w-full bg-white shadow-md rounded-lg p-8">
        <h2 class="text-2xl font-bold text-center mb-6">Crear cuenta</h2>

        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="bg-red-100 text-red-800 p-3 rounded mb-4">
                @ErrorMessage
            </div>
        }

        <EditForm Model="RegisterModel" OnValidSubmit="HandleRegister">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-1">Email</label>
                <InputText @bind-Value="RegisterModel.Email" type="email"
                           class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-green-500" />
                <ValidationMessage For="@(() => RegisterModel.Email)" />
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-1">Contraseña</label>
                <InputText @bind-Value="RegisterModel.Password" type="password"
                           class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-green-500" />
                <ValidationMessage For="@(() => RegisterModel.Password)" />
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-1">Confirmar Contraseña</label>
                <InputText @bind-Value="RegisterModel.ConfirmPassword" type="password"
                           class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-green-500" />
                <ValidationMessage For="@(() => RegisterModel.ConfirmPassword)" />
            </div>

            <button type="submit"
                    class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 transition-colors disabled:opacity-50"
                    disabled="@IsSubmitting">
                @if (IsSubmitting)
                {
                    <span>Cargando...</span>
                }
                else
                {
                    <span>Registrarse</span>
                }
            </button>
        </EditForm>

        <div class="text-center mt-4">
            <a href="/login" class="text-green-600 hover:underline">¿Ya tienes cuenta? Inicia sesión</a>
        </div>
    </div>
</div>

@code {
    private RegisterInputModel RegisterModel = new();
    private string ErrorMessage = "";
    private bool IsSubmitting = false;

    private async Task HandleRegister()
    {
        ErrorMessage = "";
        IsSubmitting = true;

        try
        {
            // Validación extra por seguridad
            if (RegisterModel.Password != RegisterModel.ConfirmPassword)
            {
                ErrorMessage = "Las contraseñas no coinciden.";
                return;
            }

            var success = await AuthService.RegisterAsync(RegisterModel.Email, RegisterModel.Password);
            if (success)
            {
                // Redirigir a login después de registrarse
                Navigation.NavigateTo("/login");
            }
            else
            {
                ErrorMessage = "No se pudo registrar el usuario.";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Ocurrió un error: {ex.Message}";
        }
        finally
        {
            IsSubmitting = false;
        }
    }

    public class RegisterInputModel
    {
        [Required(ErrorMessage = "El email es obligatorio")]
        [EmailAddress(ErrorMessage = "Email no válido")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "La contraseña es obligatoria")]
        [MinLength(6, ErrorMessage = "La contraseña debe tener al menos 6 caracteres")]
        public string Password { get; set; } = "";

        [Required(ErrorMessage = "Debes confirmar la contraseña")]
        [Compare(nameof(Password), ErrorMessage = "Las contraseñas no coinciden")]
        public string ConfirmPassword { get; set; } = "";
    }
}
