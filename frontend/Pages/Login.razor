@page "/login"
@using frontend.Services
@using System.ComponentModel.DataAnnotations
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject CustomAuthStateProvider AuthStateProvider
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage

<div class="min-h-screen flex items-center justify-center bg-gray-100">
    <div class="max-w-md w-full bg-white shadow-md rounded-lg p-8">
        <h2 class="text-2xl font-bold text-center mb-6">Iniciar sesión</h2>

        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="bg-red-100 text-red-800 p-3 rounded mb-4">
                @ErrorMessage
            </div>
        }

        <EditForm Model="LoginModel" OnValidSubmit="HandleLogin">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-1">Email</label>
                <InputText @bind-Value="LoginModel.Email" type="email" 
                           class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" />
                <ValidationMessage For="@(() => LoginModel.Email)" />
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-1">Contraseña</label>
                <InputText @bind-Value="LoginModel.Password" type="password"
                           class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" />
                <ValidationMessage For="@(() => LoginModel.Password)" />
            </div>

            <button type="submit"
                    class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition-colors disabled:opacity-50"
                    disabled="@IsSubmitting">
                @if (IsSubmitting)
                {
                    <span>Cargando...</span>
                }
                else
                {
                    <span>Iniciar sesión</span>
                }
            </button>
        </EditForm>

        <div class="text-center mt-4">
            <a href="/register" class="text-blue-600 hover:underline">¿No tienes cuenta? Regístrate</a>
        </div>
    </div>
</div>

@code {
    private LoginInputModel LoginModel = new();
    private string ErrorMessage = "";
    private bool IsSubmitting = false; //Controla el estado de envío del formulario

    private async Task HandleLogin() // Manejador del envío del formulario
    {
        ErrorMessage = ""; // Limpiar mensaje de error previo
        IsSubmitting = true; // Indicar que el formulario se está enviando

        try
        {
            var success = await AuthService.LoginAsync(LoginModel.Email, LoginModel.Password); // Llamar al servicio de autenticación
            if (success) // Si el login fue exitoso entra aqui
            {
                // Obtener token usando el nuevo método GetTokenAsync
                var token = await AuthService.GetTokenAsync(); // Obtener el token JWT a travez del metodo GetTokenAsync desde AuthService
                if (!string.IsNullOrEmpty(token)) // Si el token no es nulo o vacío
                {
                    AuthStateProvider.NotifyUserAuthentication(token); // Notificar al proveedor de estado de autenticación
                }

                Navigation.NavigateTo("/"); // Redirigir al usuario a la página principal
            }
            else
            {
                ErrorMessage = "Email o contraseña incorrectos."; // Mensaje de error genérico si no fue exitoso el login
            }
        }
        catch (Exception ex) // Capturar cualquier excepción que ocurra durante el proceso
        {
            ErrorMessage = $"Ocurrió un error: {ex.Message}"; // Mostrar mensaje de error a la hora de iniciar sesión
        }
        finally // Siempre se ejecuta al final del try-catch
        {
            IsSubmitting = false; // Restablecer el estado de envío del formulario
        }
    }

    public class LoginInputModel // Modelo de entrada para el formulario de login
    {
        [Required(ErrorMessage = "El email es obligatorio")] // Validación de campo obligatorio
        [EmailAddress(ErrorMessage = "Email no válido")] // Validación de formato de email
        public string Email { get; set; } = ""; // Inicializar con cadena vacía

        [Required(ErrorMessage = "La contraseña es obligatoria")] // Validación de campo obligatorio
        public string Password { get; set; } = ""; // Inicializar con cadena vacía
    }
}
